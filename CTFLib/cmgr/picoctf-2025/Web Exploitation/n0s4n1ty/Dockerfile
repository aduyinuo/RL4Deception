# Use an official PHP image with Apache
FROM php:7.4-apache
WORKDIR /var/www/html
COPY ./public-html/ .

# Install challenge dependencies within the image
RUN apt-get update && apt-get install -y \
    python3\
    wget \
    net-tools \
    vim \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Bring in all environment vars from cmgr
ARG SEED
ARG FLAG_FORMAT
ARG FLAG

# Create challenge directory for metadata.json and other file artifacts
RUN install -d -m 0700 /challenge/

COPY config-box.py /challenge/
WORKDIR /challenge/
RUN python3 config-box.py

# Create the uploads directory and set permissions
RUN mkdir /var/www/html/uploads/
RUN chown www-data /var/www/html/uploads/

# Add www-data user to the sudoers file and allow editing of sudoers file
RUN echo "www-data ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Ensure the sudoers file is present and everyone can edit it
RUN chmod 440 /etc/sudoers

# PUBLISH 80 AS web
EXPOSE 80

# Start Apache in the foreground
CMD ["apache2-foreground"]