
import sys
import os
import re
import json  
import pathlib
import random
import string

def generate_random_string(length):
    """Generate a random string of given length."""
    letters_and_digits = string.ascii_letters + string.digits
    return ''.join(random.choice(letters_and_digits) for i in range(length))

def main():
    
    # Retrieve flag from environment variable
    flag = os.environ.get("FLAG")

    if not flag:
        print("Flag was not read from environment. Aborting.")
        sys.exit(-1)

    # Process the flag
    flag_rand = re.search("{.*}$", flag)
    if flag_rand is None:
        print("Flag isn't wrapped by curly braces. Aborting.")
        sys.exit(-2)
    else:
        flag_rand = flag_rand.group()
        flag_rand = flag_rand[1:-1]

    # Generate a random string for the flag component
    new_flag = f"picoCTF{{D0nt_Use_Unsecure_f@nctions{flag_rand}}}"

    # Write the flag to /flag.txt
    with open("/flag.txt", "w") as f:
        f.write(new_flag)

    # Update metadata.json with the flag
    metadata = {}
    metadata['flag'] = str(new_flag)
    json_metadata = json.dumps(metadata)
    with open("/challenge/metadata.json", "w") as f:
        f.write(json_metadata)

if __name__ == "__main__":
    main()