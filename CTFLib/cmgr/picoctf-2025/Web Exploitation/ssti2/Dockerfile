# LAUNCH SSTIhost

FROM ubuntu@sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322 AS builder


# Install challenge dependencies within the image
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    python3


# Create challenge dir for metadata.json and other file artifacts
RUN mkdir /challenge


# Bring in all environment vars from cmgr
ARG SEED
ARG FLAG_FORMAT
ARG FLAG


COPY config-builder.py /challenge/config-builder.py

# Generate flag file and metadata.json
RUN python3 /challenge/config-builder.py



########################
#### Host: SSTIhost ####
########################
FROM ubuntu@sha256:626ffe58f6e7566e00254b638eb7e0f3b11d4da9675088f4781a50ae288f3322 AS SSTIhost


# Install challenge dependencies within the image
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    python3 \
    python3-pip


COPY app.py /challenge/app.py
COPY requirements.txt /challenge/requirements.txt
COPY --from=builder /challenge/flag /challenge/flag

# Run the web app
RUN python3 -m pip install -r /challenge/requirements.txt
WORKDIR /challenge
CMD flask run --host=0.0.0.0 --port=80

EXPOSE 80
# PUBLISH 80 AS web
