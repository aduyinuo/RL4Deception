# Use an official PHP image with Apache
FROM php:7.4-apache
WORKDIR /var/www/html
COPY index.html .
COPY login.php .


# Install challenge dependencies within the image
RUN apt-get update && apt-get install -y \
    python3\
    && rm -rf /var/lib/apt/lists/*

# Bring in all environment vars from cmgr
ARG SEED
ARG FLAG_FORMAT
ARG FLAG

# Create challenge directory for metadata.json and other file artifacts
RUN install -d -m 0700 /challenge/

# Copy the Python script to the challenge directory
COPY flag.py /challenge/

# Set the working directory to /challenge
WORKDIR /challenge/

# Run the Python script to generate the flag
RUN python3 flag.py

# Move the generated flag.txt to a location accessible by the web server
RUN mv /challenge/flag.txt /var/www/html/flag.txt

# Ensure the web server can read the flag file
RUN chown www-data:www-data /var/www/html/flag.txt && chmod 644 /var/www/html/flag.txt

# PUBLISH 80 AS web
EXPOSE 80

# Start Apache in the foreground
CMD ["apache2-foreground"]