FROM ubuntu:20.04

RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y openssh-server \
    python3 \
    sudo \
    vim

RUN useradd -m -s /bin/bash picoctf
# This might be leftover from copying a template problem. It just enables
# cheese solutions
#RUN echo 'picoctf  ALL=(ALL) /usr/bin/vi ' > /etc/sudoers.d/picoctf
#RUN chmod 0440 /etc/sudoers.d/picoctf
RUN mkdir  /challenge
RUN mkdir /var/run/sshd
ARG FLAG
COPY password.py /challenge/flag.py
USER root
RUN python3 /challenge/flag.py
RUN rm /challenge/flag.py
RUN /bin/bash set-passwords.sh && rm set-passwords.sh
WORKDIR /home/picoctf
RUN chmod 777 /usr/lib/python3.8/base64.py
RUN echo 'picoctf ALL=(root) NOPASSWD: /usr/bin/python3 /home/picoctf/.server.py' >> /etc/sudoers
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin no/g' /etc/ssh/sshd_config
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile
COPY server.py /home/picoctf/.server.py
RUN chmod 644 /home/picoctf/.server.py
RUN chmod 0000 /challenge

RUN /usr/bin/ssh-keygen -A
RUN sudo service ssh --full-restart

CMD /usr/sbin/sshd -D

EXPOSE 22
# PUBLISH 22 AS ssh
