.PHONY: main
main: flag binary metadata.json artifacts.tar.gz

flag:	
	@echo -n "${FLAG}" > flag.txt
	hexdump -vn 4 -e ' /1 "%02x"'  /dev/urandom >> flag.txt
	@echo -n "}" >> flag.txt

binary:	
	gcc -m32 -fno-stack-protector -c -masm=intel asm.S
	gcc -m32 -fno-stack-protector -c vuln.c
	gcc -m32 -no-pie -pedantic -fno-stack-protector --std=gnu99 -o vuln vuln.o asm.o	

artifacts.tar.gz: vuln.c vuln
	tar czvf $@ $^


metadata.json:
	@echo "Creating the metadata file..."
	@echo -n "{\"flag\":\"" > metadata.json
	echo -n $(shell cat flag.txt) >> metadata.json
	@echo -n "\"}" >> metadata.json


.PHONY: clean
clean:
	rm -f flag.txt
	rm -f vuln
	rm -f metadata.json
	rm -f vuln.o asm.o
